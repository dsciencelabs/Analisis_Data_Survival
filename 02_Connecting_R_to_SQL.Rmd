# Connecting R to SQL


## Introduction

A database is a structured set of data. Terminology is a little bit different when working with a database management system compared to working with data in R.

* **field:** variable or quantity
* **record:** collection of fields
* **table:** collection of records with all the same fields
* **database:** collection of tables

The relationship between R terminology and database terminology is explained below.

|R terminology        |Database terminology |
|:------------------- |:--------------------|
|     column	        |        field        |
|     row	            |        record       |
| data frame	        |        table        |
| types of columns	  |      table schema   |
| collection of data  |   frames	database  |

***

## Connecting R to SQL

Connecting R to SQL databases allows you to leverage the power of R for data analysis while directly interacting with and querying data stored in relational databases. This connection enables you to retrieve, manipulate, and analyze data using SQL queries within your R environment. 

```{r coneccting,echo=FALSE, fig.cap='Connecting R to SQL [https://rviews.rstudio.com](https://rviews.rstudio.com/2017/05/17/databases-using-r/)', tidy=FALSE, out.width='100%', fig.align='center'}
library(knitr)
include_graphics("./images/Bab2/coneccting_db_in_R.png")
```

Here's a step-by-step introduction to connecting R to an SQL database:


### Install Required Packages

First, you need to install R packages that facilitate database connections and SQL interactions. The DBI package provides a common interface for database connections, and you'll also need a database-specific package like RMySQL for MySQL, RPostgreSQL for PostgreSQL, or RODBC for ODBC connections.

You can install these packages using the following commands:

```{r eval=FALSE}
install.packages(c(
                   "RMariaDB",
                   "RMySQL",
                   "RPostgres"
                   "RSQLite",
                   )
                 )
```

### Load Packages

Then, load all these requirement packages:

```{r eval=FALSE}
# install.packages("pacman")
pacman::p_load(
               RMariaDB,             # Database Interface and 'MariaDB' Driver
               RMySQL,               # Database Interface and 'RMySQL' Driver
               RPostgres             # Database Interface and 'RPostgres' Driver
               RSQLite,              # Database Interface and 'RSQLite' Driver
          )
```


### Establish a Connection

There are many ways to connect your database with R. This article shows you three of the most common ways:

#### MariaDB {-}

```{r eval=FALSE}
MariaDB <- dbConnect(RMariaDB::MariaDB(), 
                  user='root',
                  password='', 
                  dbname='bakti', 
                  host='localhost')
dbListTables(MariaDB)                             # table list on your database
dbExecute(MariaDB,"CREATE DATABASE new_MariaDB")  # Create a new Database
dbExecute(MariaDB,"DROP DATABASE new_MariaDB")    # Drop a Database
```


#### MySQL {-}

```{r eval=FALSE}
MySQL <- dbConnect(MySQL(), 
                  user='root',
                  password='', 
                  dbname='bakti', 
                  host='localhost')
dbListTables(MySQL)                               # table list on your database
dbExecute(MySQL,"CREATE DATABASE new_MySQL")      # Create a new Database
dbExecute(MySQL,"DROP DATABASE new_MySQL")        # Drop a Database
```

#### Postgres {-}

```{r eval=FALSE}
postgres <- dbConnect(RPostgres::Postgres(), 
                  user='postgres',
                  password='1234', 
                  dbname='postgres', 
                  host='localhost')
dbListTables(postgres)                               # table list on your database
dbExecute(postgres,"CREATE DATABASE new_MySQL")      # Create a new Database
dbExecute(postgres,"DROP DATABASE new_MySQL")        # Drop a Database
```

#### SQLite {-}

```{r eval=FALSE}
RSQLite <- dbConnect(RSQLite::SQLite(), "folder_db/mydb3.sqlite")
dbListTables(RSQLite)                             # table list on your database
```

* *Notes:* RSQLite will store the database you created in your current working directory.


## Import Data 

This section can be ignored if the data (table) that you need is already registered in your database. If not, then it is necessary to import data set according to your available files, download it below:

* [Customers.csv](https://raw.githubusercontent.com/dsciencelabs/dataset/master/Customers.csv)
* [Categories.csv](https://raw.githubusercontent.com/dsciencelabs/dataset/master/Categories.csv) 
* [Employees.csv](https://raw.githubusercontent.com/dsciencelabs/dataset/master/Employees.csv) 
* [OrderDetails.csv](https://raw.githubusercontent.com/dsciencelabs/dataset/master/OrderDetails.csv)  
* [Orders.csv](https://raw.githubusercontent.com/dsciencelabs/dataset/master/Orders.csv)
* [Products.csv](https://raw.githubusercontent.com/dsciencelabs/dataset/master/Products.csv)
* [Shippers.csv](https://raw.githubusercontent.com/dsciencelabs/dataset/master/Shippers.csv)
* [Suppliers.csv](https://raw.githubusercontent.com/dsciencelabs/dataset/master/Suppliers.csv)
* [RawDatabase.xlsx](https://view.officeapps.live.com/op/view.aspx?src=https%3A%2F%2Fraw.githubusercontent.com%2Fdsciencelabs%2Fdataset%2Fmaster%2FRawDatabase.xlsx&wdOrigin=BROWSELINK)

### CSV Files

When you're working with files in R, such as reading data from a CSV file or saving plots as image files, R needs to know the location of these files. By setting the working directory, you provide a starting point for R to look for and save files. 

In R, the setwd() function is used to set the working directory for your R session. The working directory is the folder on your computer where R will look for files and where it will save files unless you specify a different location. Here's why the setwd() function is important and when you might use it:

```{r, eval=FALSE}
# Set the working directory
setwd("/path/to/your/folder")
```

```{r, eval=FALSE}
# Now you can read CSV files without specifying the full path
data <- read.csv("file.csv")
```

Replace "/path/to/your/folder" with the actual path to the folder containing your CSV files. Then, you can run the following code!.

```{r eval=FALSE}
Customers   <-read.csv("data/Customers.csv")
Categories  <-read.csv("data/Categories.csv")  
Employees   <-read.csv("data/Employees.csv")  
OrderDetails<-read.csv("data/OrderDetails.csv")  
Orders      <-read.csv("data/Orders.csv")  
Products    <-read.csv("data/Products.csv")  
Shippers    <-read.csv("data/Shippers.csv")
Suppliers   <-read.csv("data/Suppliers.csv")  
```


### XLSX Files 

```{r, eval=F}
library("readxl")                                  
Customers   <-read_excel("data/RawDatabase.xlsx",sheet=1)      
Categories  <-read_excel("data/RawDatabase.xlsx",sheet=2) 
Employees   <-read_excel("data/RawDatabase.xlsx",sheet=3)
OrderDetails<-read_excel("data/RawDatabase.xlsx",sheet=4) 
Orders      <-read_excel("data/RawDatabase.xlsx",sheet=5)
Products    <-read_excel("data/RawDatabase.xlsx",sheet=6) 
Shippers    <-read_excel("data/RawDatabase.xlsx",sheet=7)  
Suppliers   <-read_excel("data/RawDatabase.xlsx",sheet=8)  
```


## Write Dataframe to Database

The key here is the `dbWriteTable` function which allows us to write an R data frame directly to a database table. The data frame's column names will be used as the database table's fields. In the following example I use `RMariaDB` connection, you can apply another driver as you like.


```{r eval=FALSE}
new_con <- dbConnect(MariaDB(), 
                  user='root',
                  password='', 
                  dbname='new_MariaDB', 
                  host='localhost')

dbWriteTable(new_con, "Customers", Customers, append=T) 
dbWriteTable(new_con, "Categories", Categories, append=T) 
dbWriteTable(new_con, "Employees", Employees, append=T) 
dbWriteTable(new_con, "OrderDetails", OrderDetails, append=T) 
dbWriteTable(new_con, "Orders", Orders, append=T) 
dbWriteTable(new_con, "Products", Products, append=T) 
dbWriteTable(new_con, "Shippers", Shippers, append=T) 
dbWriteTable(new_con, "Suppliers", Suppliers, append=T) 
```

*Note:* Some important things that must be considered when storing table data are as follows:

* Data Structure adjustments
* Changes Data type  (especially, Date and Time)

In this case, we have a problem with the data table `Employees` and `Orders`. When you consider these Table (Employees and Orders), you will find there is no date are written correctly in the database. In order to handle this problem, just type the following code in your R console:

```{r eval=FALSE}
dbRemoveTable(new_con, "Orders")
```
```{r eval=FALSE}
Orders["OrderDate"] <-as.Date(Orders$OrderDate, format = "%Y-%m-%d") 
```

```{r eval=FALSE}
dbWriteTable(new_con, "Orders", Orders, append=T) 
```


*Your Exercise:* Do the same thing to update data table `Employees`


## Basic SQL in R

### SELECT

The SELECT statement is used to select data from a database.

```{r eval=FALSE, message=F}
library(DT)
df1<-dbGetQuery(new_con,'SELECT city
                         FROM Customers')
datatable(df1)
```

### WHERE

The WHERE clause is used to filter records, extract only those records that fulfill a specified condition.

```{r eval=FALSE}
df2<-dbGetQuery(new_con,"SELECT * 
                         FROM Customers 
                         WHERE Country='Germany'")
datatable(df2)
```

### INSERT INTO

If you are adding values for all the columns of the table, you do not need to specify the column names in the SQL query. However, make sure the order of the values is in the same order as the columns in the table. The INSERT INTO syntax would be as follows:

```{r eval=FALSE}
dbExecute(new_con,"INSERT INTO Customers(CustomerName,ContactName,Address,City,PostalCode, Country)
                   VALUES('Bakti','Siregar','Jl.Bahagia Selalu','Tangerang','081369','Indonesia')")
```


### DELETE

The DELETE statement is used to delete existing records in a table.


```{r eval=FALSE}
dbExecute(new_con,"DELETE FROM Customers
                   WHERE CustomerName ='Bakti' ")  
```


### UPDATE

The UPDATE statement is used to modify the existing records in a table.

```{r eval=FALSE}
dbExecute(new_con,"UPDATE Customers
                   SET ContactName = 'Alfred Schmidt', City= 'Frankfurt'
                   WHERE CustomerID = 1")
```

### Disconnect Database

If you are done with the query process and you don't want to use it anymore, you should disconnect the connection from your database.

```{r eval=FALSE}
dbDisconnect(new_con)                                        # disconnect from your database
```


## Your Job

1. Write Dataframe to your Database directory, using the following Engine:

  * RMySQL
  * RPostgres            
  * RSQLite

2. Create a 'Basic Queries' tutorial using all engine that you already use at task no 1, (Such as: `SELECT`, `WHERE`, `INSERT INTO`, `DELETE`,  and `UPDATE`)!



